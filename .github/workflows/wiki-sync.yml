name: Wiki auto-sync workflow

on:
  push:
    branches:
      - autowiki
    paths:
      - ".wiki/**"
  repository_dispatch:
    types: [docs]
  gollum:
  workflow_dispatch:

env:
  GIT_AUTHOR_NAME: Actionbot
  GIT_AUTHOR_EMAIL: actions@github.com

jobs:
  check-trigger-event:
    runs-on: ubuntu-latest
    outputs:
      trigger_message: ${{ steps.check_trigger_event.outputs.trigger_message }}
    steps:
      - name: Check Trigger Event
        id: check_trigger_event
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "::set-output name=trigger_message::This workflow was triggered manually. Check the Manual Wiki Sync workflow in the Actions tab to see who triggered it."
          else
            echo "::set-output name=trigger_message::This workflow was triggered by ${{ github.event_name }}."
          fi

  print-trigger-message:
    needs: [check-trigger-event]
    runs-on: ubuntu-latest
    steps:
      - name: Print Trigger Message
        run: echo "${{ needs.check-trigger-event.outputs.trigger_message }}"

  job-sync-docs-to-wiki:
    runs-on: ubuntu-latest
    needs: check-trigger-event
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Sync docs to wiki
        uses: newrelic/wiki-sync-action@main
        with:
          source: .wiki
          destination: wiki
          token: ${{ secrets.NEWRELIC_BOT_TOKEN }}
          gitAuthorName: ${{ env.GIT_AUTHOR_NAME }}
          gitAuthorEmail: ${{ env.GIT_AUTHOR_EMAIL }}
  
  job-sync-wiki-to-docs:
    runs-on: ubuntu-latest
    needs: check-trigger-event
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.NEWRELIC_BOT_TOKEN }}
          ref: autowiki

      - name: Sync Wiki to Docs
        uses: newrelic/wiki-sync-action@main
        with:
          source: wiki
          destination: .wiki
          token: ${{ secrets.NEWRELIC_BOT_TOKEN }}
          gitAuthorName: ${{ env.GIT_AUTHOR_NAME }}
          gitAuthorEmail: ${{ env.GIT_AUTHOR_EMAIL }}
          branch: autowiki
